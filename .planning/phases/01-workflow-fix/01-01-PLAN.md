---
phase: 01-workflow-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - n8n-workflows/07-readme-generator.json
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "User can trigger README generation from n8n UI and see it pushed to GitHub"
    - "No external script files are required for README workflow"
    - "Workflow execution logs show successful GitHub push without errors"
    - "Discord receives notification on README push (success or failure)"
  artifacts:
    - path: "n8n-workflows/07-readme-generator.json"
      provides: "Complete README generation and GitHub push workflow"
      contains: "httpRequest"
    - path: "CLAUDE.md"
      provides: "Project instructions without script workaround"
      not_contains: "/tmp/generate-readme.js"
  key_links:
    - from: "07-readme-generator.json (Generate README node)"
      to: "GitHub API"
      via: "HTTP Request node with base64 encoded content"
      pattern: "api.github.com/repos/.*/contents"
    - from: "07-readme-generator.json (push result)"
      to: "Discord webhook"
      via: "HTTP Request node with embed"
      pattern: "discord.com/api/webhooks"
---

<objective>
Fix the n8n README generator workflow to push directly to GitHub without requiring external scripts.

Purpose: The current workflow generates README content but relies on an external script workaround to actually push to GitHub. This creates operational friction and makes the pipeline non-autonomous. Fixing this enables full workflow automation.

Output: Updated workflow that generates README, encodes it, pushes to GitHub via API, and notifies Discord of results. CLAUDE.md cleaned of script workaround.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-workflow-fix/01-CONTEXT.md

# Existing workflow to modify
@n8n-workflows/07-readme-generator.json

# Reference for HTTP Request + Discord pattern
@n8n-workflows/08-discord-notifier.json

# Contains workaround to remove
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GitHub push and Discord notification to workflow</name>
  <files>n8n-workflows/07-readme-generator.json</files>
  <action>
Modify the README generator workflow to add GitHub push capability:

1. **Update the existing "Generate README" Code node** to also output base64-encoded content:
   - After generating `readme_content`, add: `readme_base64: Buffer.from(readme).toString('base64')`
   - Keep existing stats output

2. **Add "Get Current SHA" HTTP Request node** after Generate README:
   - Method: GET
   - URL: `https://api.github.com/repos/911fund/skill-of-skills/contents/README.md`
   - Headers: `Authorization: token GITHUB_TOKEN_PLACEHOLDER`
   - This gets the current file's SHA (required for updates)
   - Handle 404 gracefully (file might not exist yet)

3. **Add "Push to GitHub" HTTP Request node** after Get Current SHA:
   - Method: PUT
   - URL: `https://api.github.com/repos/911fund/skill-of-skills/contents/README.md`
   - Headers: `Authorization: token ...`, `Content-Type: application/json`
   - Body (use expression to build JSON):
     ```json
     {
       "message": "Update README - {{ $('Generate README').item.json.stats.total }} tools indexed",
       "content": "{{ $('Generate README').item.json.readme_base64 }}",
       "sha": "{{ $('Get Current SHA').item.json.sha }}"
     }
     ```
   - If sha is empty/undefined (new file), omit the sha field

4. **Add "Discord Success" HTTP Request node** on success path:
   - Method: POST
   - URL: `={{[object Object].DISCORD_WEBHOOK_URL}}`
   - Body: Embed with green color (0x00FF00), title "README Updated", fields for tool count, commit URL, timestamp

5. **Add error handling branch** with "Discord Failure" node:
   - On HTTP error from GitHub push, route to failure notification
   - Red color (0xFF0000), title "README Push Failed", include error message

6. **Update connections:**
   - Webhook -> DB queries (parallel) -> Generate README -> Get Current SHA -> Push to GitHub -> Discord Success -> Respond
   - Push to GitHub (error output) -> Discord Failure -> Respond

7. **Update the Respond node** to return success/failure status with commit URL

Note: n8n Code nodes have access to `Buffer` - this is different from expression contexts where `Buffer.from()` fails. The Code node is the right place for base64 encoding.
  </action>
  <verify>
1. Valid JSON: `cat n8n-workflows/07-readme-generator.json | jq .`
2. Node count increased (was 6 nodes, should be ~10 nodes now)
3. Has httpRequest nodes: `grep -c "httpRequest" n8n-workflows/07-readme-generator.json` (expect 3+)
4. Has GitHub API URL: `grep "api.github.com" n8n-workflows/07-readme-generator.json`
5. Has Discord webhook URL: `grep "discord.com/api/webhooks" n8n-workflows/07-readme-generator.json`
  </verify>
  <done>
Workflow JSON includes: base64 encoding in Code node, GET for SHA, PUT for push, Discord success notification, Discord failure notification, proper error routing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove script workaround from CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md to remove the script workaround section:

1. **Remove the entire "README Generation" section** that contains:
   - The explanation about n8n Push to GitHub node issues
   - The multi-line bash script using `/tmp/generate-readme.js`
   - References to the generator script

2. **Update the "Known Issues" section** to mark the n8n issue as resolved:
   - Change: "n8n Push to GitHub: The HTTP Request node can't use `Buffer.from()` in expressions. Use the standalone script above."
   - To: "~~n8n Push to GitHub~~ - FIXED: Workflow 07 now pushes directly via GitHub API"
   - Or simply remove this known issue entirely since it's fixed

3. **Keep all other sections intact:**
   - Overview, Architecture, Docker Commands, Credentials, n8n Workflows, Database Queries

4. **Optionally add a note** in n8n Workflows section:
   - `07-readme-generator.json` - Generates and pushes README to GitHub, notifies Discord
  </action>
  <verify>
1. No `/tmp/generate-readme.js` reference: `grep -c "generate-readme.js" CLAUDE.md` (expect 0)
2. No multi-line bash script for README: `grep -c "CONTENT_BASE64" CLAUDE.md` (expect 0)
3. Still has core sections: `grep -c "## " CLAUDE.md` (expect 5+)
4. Valid markdown structure
  </verify>
  <done>
CLAUDE.md no longer contains the script workaround. The workflow is documented as working natively. Developers can trigger README generation from n8n UI without needing external scripts.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete README generator workflow with GitHub push and Discord notifications. Removed script workaround from documentation.
  </what-built>
  <how-to-verify>
1. **Import updated workflow to n8n:**
   - Open n8n UI at http://localhost:5678
   - Import `n8n-workflows/07-readme-generator.json` (or update existing)
   - Verify all nodes are connected properly

2. **Test the workflow:**
   - Trigger the webhook manually from n8n UI (click "Test workflow")
   - Or: `curl -X POST http://localhost:5678/webhook/generate-readme`

3. **Verify GitHub push:**
   - Check https://github.com/911fund/skill-of-skills/commits/main
   - Should see new commit "Update README - X tools indexed"
   - README.md should have updated content

4. **Verify Discord notification:**
   - Check the Discord channel for the webhook
   - Should see green embed with tool count and commit link

5. **Test failure handling (optional):**
   - Temporarily break the GitHub token in the workflow
   - Trigger workflow
   - Should see red embed in Discord with error message
  </how-to-verify>
  <resume-signal>Type "approved" if workflow successfully pushed to GitHub and Discord notified. Otherwise describe issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria (from ROADMAP.md):
1. User can trigger README generation from n8n UI and see it pushed to GitHub
2. No external script files are required for README workflow
3. Workflow execution logs show successful GitHub push without errors
</verification>

<success_criteria>
- [ ] Workflow 07 contains GitHub API push via HTTP Request node
- [ ] Workflow 07 contains Discord notification nodes (success and failure)
- [ ] Base64 encoding happens in Code node (not expressions)
- [ ] CLAUDE.md has no script workaround
- [ ] Manual test confirms end-to-end: trigger -> generate -> push -> notify
</success_criteria>

<output>
After completion, create `.planning/phases/01-workflow-fix/01-01-SUMMARY.md`
</output>
