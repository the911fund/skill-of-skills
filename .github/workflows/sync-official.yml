name: Sync Official Plugins

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch official plugins
        id: fetch
        run: |
          # Fetch from Anthropic's official plugin directory
          PLUGINS=$(curl -s "https://api.github.com/repos/anthropics/claude-plugins-official/contents/plugins" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json")

          echo "$PLUGINS" > plugins.json
          echo "count=$(echo "$PLUGINS" | jq length)" >> $GITHUB_OUTPUT

      - name: Parse and send to n8n
        run: |
          # Extract plugin directories and send to n8n
          cat plugins.json | jq -c '.[] | select(.type == "dir") | {name: .name, path: .path, url: .html_url}' | while read plugin; do
            NAME=$(echo "$plugin" | jq -r '.name')
            URL=$(echo "$plugin" | jq -r '.url')

            # Send each plugin to n8n sync webhook
            curl -s -X POST "${{ secrets.N8N_SYNC_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$NAME\",
                \"repo_url\": \"https://github.com/anthropics/claude-plugins-official\",
                \"plugin_path\": \"plugins/$NAME\",
                \"source\": \"github_official\",
                \"is_official\": true,
                \"is_verified\": true
              }"

            sleep 1  # Rate limiting
          done

      - name: Summary
        run: |
          echo "âœ… Synced ${{ steps.fetch.outputs.count }} official plugins"
