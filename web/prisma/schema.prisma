generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ToolType {
  skill
  plugin
  collection
  cli_tool
  mcp_server
  prompt_pack
  workflow
  extension
  resource

  @@map("tool_type")
}

enum DiscoverySource {
  github_search
  github_official
  x_post
  x_reply
  x_entity_extraction
  reddit_post
  manual_submission
  influencer_recommendation

  @@map("discovery_source")
}

enum RiskLevel {
  low
  medium
  high
  critical

  @@map("risk_level")
}

enum ValidationStatus {
  pending
  validating
  passed
  failed
  skipped
  manual_review

  @@map("validation_status")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  slug         String   @unique
  description  String?
  icon         String?
  keywords     String[] @default([])
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  tools        Tool[]

  @@map("categories")
}

model Tool {
  id                    String           @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String           @unique
  repoUrl               String?          @unique @map("repo_url")
  repoOwner             String?          @map("repo_owner")
  repoName              String?          @map("repo_name")
  toolType              ToolType         @default(skill) @map("tool_type")
  categoryId            String?          @map("category_id") @db.Uuid
  category              Category?        @relation(fields: [categoryId], references: [id])
  tags                  String[]         @default([])
  description           String?
  installCommand        String?          @map("install_command")
  hasSkillMd            Boolean          @default(false) @map("has_skill_md")
  hasClaudePlugin       Boolean          @default(false) @map("has_claude_plugin")
  hasMcpJson            Boolean          @default(false) @map("has_mcp_json")
  riskLevel             RiskLevel        @default(low) @map("risk_level")
  riskReasons           String[]         @default([]) @map("risk_reasons")
  validationStatus      ValidationStatus @default(pending) @map("validation_status")
  lastValidatedAt       DateTime?        @map("last_validated_at") @db.Timestamptz
  spawnsSubagents       Boolean          @default(false) @map("spawns_subagents")
  stars                 Int              @default(0)
  forks                 Int              @default(0)
  lastCommitAt          DateTime?        @map("last_commit_at") @db.Timestamptz
  license               String?
  xMentionCount         Int              @default(0) @map("x_mention_count")
  xRecommendationCount  Int              @default(0) @map("x_recommendation_count")
  redditMentionCount    Int              @default(0) @map("reddit_mention_count")
  githubScore           Float            @default(0) @map("github_score")
  socialScore           Float            @default(0) @map("social_score")
  recencyScore          Float            @default(0) @map("recency_score")
  influencerScore       Float            @default(0) @map("influencer_score")
  compositeScore        Float            @default(0) @map("composite_score")
  trendingScore         Float            @default(0) @map("trending_score")
  source                DiscoverySource
  sourceUrl             String?          @map("source_url")
  discoveredBy          String?          @map("discovered_by")
  isActive              Boolean          @default(true) @map("is_active")
  isOfficial            Boolean          @default(false) @map("is_official")
  isVerified            Boolean          @default(false) @map("is_verified")
  discoveredAt          DateTime         @default(now()) @map("discovered_at") @db.Timestamptz
  updatedAt             DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  searchVector          Unsupported("tsvector")? @map("search_vector")
  socialMentions        SocialMention[]
  metricsHistory        MetricsHistory[]
  ratings               Rating[]
  comments              Comment[]
  favorites             Favorite[]

  @@index([compositeScore(sort: Desc)], map: "idx_tools_composite")
  @@index([trendingScore(sort: Desc)], map: "idx_tools_trending")
  @@index([toolType], map: "idx_tools_type")
  @@map("tools")
}

model Influencer {
  id                      String          @id @default(uuid()) @db.Uuid
  platform                String
  username                String
  displayName             String?         @map("display_name")
  followers               Int             @default(0)
  recommendationCount     Int             @default(0) @map("recommendation_count")
  accurateRecommendations Int             @default(0) @map("accurate_recommendations")
  trustScore              Float           @default(0.5) @map("trust_score")
  isVerified              Boolean         @default(false) @map("is_verified")
  isOfficial              Boolean         @default(false) @map("is_official")
  firstSeenAt             DateTime        @default(now()) @map("first_seen_at") @db.Timestamptz
  lastActiveAt            DateTime        @default(now()) @map("last_active_at") @db.Timestamptz
  socialMentions          SocialMention[]
  unknownMentions         UnknownMention[]

  @@unique([platform, username])
  @@map("influencers")
}

model SocialMention {
  id              String      @id @default(uuid()) @db.Uuid
  toolId          String?     @map("tool_id") @db.Uuid
  tool            Tool?       @relation(fields: [toolId], references: [id], onDelete: Cascade)
  influencerId    String?     @map("influencer_id") @db.Uuid
  influencer      Influencer? @relation(fields: [influencerId], references: [id])
  platform        String
  postType        String?     @map("post_type")
  postUrl         String      @map("post_url")
  postId          String?     @map("post_id")
  content         String?
  authorUsername  String?     @map("author_username")
  authorFollowers Int         @default(0) @map("author_followers")
  likes           Int         @default(0)
  retweets        Int         @default(0)
  replies         Int         @default(0)
  isRecommendation Boolean    @default(false) @map("is_recommendation")
  isComparison    Boolean     @default(false) @map("is_comparison")
  comparedTo      String[]    @default([]) @map("compared_to")
  sentiment       String?
  postedAt        DateTime?   @map("posted_at") @db.Timestamptz
  scrapedAt       DateTime    @default(now()) @map("scraped_at") @db.Timestamptz

  @@unique([platform, postUrl])
  @@map("social_mentions")
}

model UnknownMention {
  id              String      @id @default(uuid()) @db.Uuid
  toolName        String      @map("tool_name")
  normalizedName  String?     @map("normalized_name")
  platform        String
  postUrl         String      @map("post_url")
  mentionedBy     String?     @map("mentioned_by")
  influencerId    String?     @map("influencer_id") @db.Uuid
  influencer      Influencer? @relation(fields: [influencerId], references: [id])
  contextSnippet  String?     @map("context_snippet")
  confidenceScore Float?      @map("confidence_score")
  status          String      @default("pending")
  resolvedToolId  String?     @map("resolved_tool_id") @db.Uuid
  discoveredAt    DateTime    @default(now()) @map("discovered_at") @db.Timestamptz

  @@unique([normalizedName, postUrl])
  @@map("unknown_mentions")
}

model DiscoveryQueue {
  id              String    @id @default(uuid()) @db.Uuid
  repoUrl         String?   @unique @map("repo_url")
  toolName        String?   @map("tool_name")
  source          DiscoverySource
  sourceUrl       String?   @map("source_url")
  discoveredBy    String?   @map("discovered_by")
  stars           Int       @default(0)
  socialMentions  Int       @default(0) @map("social_mentions")
  status          String    @default("pending")
  rejectionReason String?   @map("rejection_reason")
  queuedAt        DateTime  @default(now()) @map("queued_at") @db.Timestamptz
  processedAt     DateTime? @map("processed_at") @db.Timestamptz

  @@map("discovery_queue")
}

model MetricsHistory {
  id             String   @id @default(uuid()) @db.Uuid
  toolId         String   @map("tool_id") @db.Uuid
  tool           Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  recordedDate   DateTime @default(now()) @map("recorded_date") @db.Date
  stars          Int?
  compositeScore Float?   @map("composite_score")

  @@unique([toolId, recordedDate])
  @@map("metrics_history")
}

// User engagement tables

model Rating {
  id        String   @id @default(uuid()) @db.Uuid
  toolId    String   @map("tool_id") @db.Uuid
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  sessionId String   @map("session_id")
  rating    Int
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@unique([toolId, sessionId])
  @@map("ratings")
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  toolId    String   @map("tool_id") @db.Uuid
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  sessionId String   @map("session_id")
  author    String?
  content   String
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("comments")
}

model Favorite {
  id        String   @id @default(uuid()) @db.Uuid
  toolId    String   @map("tool_id") @db.Uuid
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  sessionId String   @map("session_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@unique([toolId, sessionId])
  @@map("favorites")
}
